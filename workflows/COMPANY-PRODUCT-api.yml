
name: API CI/CD

on:
  pull_request:
    branches:
      - main
    paths:
      - .github/workflows/COMPANY-PRODUCT-api.yml
      - src/**
  push:
    branches:
      - main
    paths:
      - .github/workflows/COMPANY-PRODUCT-api.yml
      - src/**
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to run"
        required: true
        default: "development"

permissions:
  id-token: write
  contents: read
  security-events: write

env:
  SCRIPTS_PATH: "./.github/scripts"
  SRC_PATH: "./src"
  SRC_SLN: "PRODUCT.sln"
  API_PATH: "Presentation.WebApi"
  API_PROJECT: "Presentation.WebApi.csproj"
  TEST_PATH: "Tests.Specs.Integration"
  TEST_PROJECT: "Tests.Specs.Integration.csproj"
  AZURE_WEBAPP_NAME: "api-PRODUCT-dev-001"
  AZURE_WEBAPP_PACKAGE_PATH: "."
  AZURE_RG_NAME: "COMPANY-rg-SUBSCRIPTION-PRODUCT-dev-001"
  APPI_NAME: "appi-PRODUCT-dev-001"

jobs:
  ci:
    name: "API CI"
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch' || github.event_name == 'push'
    environment: development
    strategy:
      matrix:
        DOTNET_VERSION: ["8.x", "9.x", "10.x"]

    env:
      RUNTIME_ENV: "Development"

    steps:
      - name: checkout
        uses: actions/checkout@v3

      - name: dotnet version ${{ matrix.DOTNET_VERSION }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ matrix.DOTNET_VERSION }}

      - name: Set-Version.ps1
        run: |
          $version = ${{ env.SCRIPTS_PATH }}/ci/Set-Version.ps1 -Path ${{ env.SRC_PATH }} -VersionToReplace 1.0.0 -Major 1 -Minor 1
          echo $version
          echo "VERSION=$version" >> $GITHUB_ENV
        shell: pwsh

      - name: pipeline environment configuration
        run: |
          echo "ASPNETCORE_ENVIRONMENT=${{ env.RUNTIME_ENV }}" >> $GITHUB_ENV
        shell: pwsh


      # Set OpenAI API key as environment variable for test
      - name: Set OpenAI API Key for Test
        run: |
          echo "OpenAI__ApiKey=${{ secrets.OPENAI_APIKEY }}" >> $GITHUB_ENV
        shell: pwsh
          
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: csharp

      - name: Build
        run: |
          dotnet build ${{ env.SRC_PATH }}/${{ env.SRC_SLN }} --configuration Release
        shell: pwsh

      - name: Test
        run: |
          mkdir -p TestResults-${{ matrix.DOTNET_VERSION }}
          dotnet test ${{ env.SRC_PATH }}/${{ env.TEST_PATH }}/${{ env.TEST_PROJECT }} --logger "trx;LogFileName=test_results.trx" --results-directory TestResults-${{ matrix.DOTNET_VERSION }} --verbosity normal
        shell: pwsh

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: dotnet-results-${{ matrix.DOTNET_VERSION }}
          path: TestResults-${{ matrix.DOTNET_VERSION }}
        if: ${{ always() }}

      - name: Publish API artifact
        run: |
          dotnet publish ${{ env.SRC_PATH }}/${{ env.API_PATH }}/${{ env.API_PROJECT }} --configuration Release --no-build -o api_output
        shell: pwsh

      - name: Upload API build artifact
        uses: actions/upload-artifact@v4
        with:
          name: api-artifact
          path: api_output

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4

  cd:
    name: "API CD"
    runs-on: ubuntu-latest
    needs: ci
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: production
    strategy:
      matrix:
        DOTNET_VERSION: ["8.x", "9.x", "10.x"]
    env:
      API_OUTPUT: "api_output"
    steps:
      - name: Download API build artifact
        uses: actions/download-artifact@v4
        with:
          name: api-artifact
          path: api_output

      # Re-transform appsettings with secrets at deploy time
      - name: App Settings Variable Substitution (CD)
        uses: microsoft/variable-substitution@v1
        with:
          files: '${{ env.SRC_PATH }}/${{ env.API_PATH }}/appsettings.json, ${{ env.SRC_PATH }}/${{ env.API_PATH }}/appsettings.${{ env.RUNTIME_ENV }}.json'
        env:
          OpenAI.ApiKey: ${{ secrets.OPENAI_APIKEY }}

      # Example deployment step:
      # - name: Deploy to Azure Web App
      #   uses: azure/webapps-deploy@v2
      #   with:
      #     app-name: ${{ env.AZURE_WEBAPP_NAME }}
      #     package: '${{ env.AZURE_WEBAPP_PACKAGE_PATH }}/api_output'

